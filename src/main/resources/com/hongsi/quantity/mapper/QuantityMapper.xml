<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 1. com.hongsi.quantity.mapper.QuantityMapper 인터페이스 선언 -->
<!-- 2. root-context.xml <mybatis-spring:scan ~~ /> 태그로 기본 패키지 지정 -->
<!-- 3. com.hongsi.quantity.mapper.QuantityMapper.xml 실행 작성 - src/main/resources -->
<!-- <![CDATA[ 이 사이에 있는 것은 mybatis가 처리하지 않고 그대로 넘긴다. DB에서 처리되도록 ]]> -->

<!-- QuantityVO(cno=34, code=SNS_100_001, name=SNS_100, amount=100, ingredient=Whole Wheat, igt_code=in_028, qty=4) -->
<mapper namespace="com.hongsi.quantity.mapper.QuantityMapper">
	<select id="list" resultType="com.hongsi.quantity.vo.QuantityVO">
	SELECT 
		CNO,
		CODE,
		NAME,
		AMOUNT,
		INGREDIENT,
		IGT_CODE,
		QTY
	FROM QUANTITY
	ORDER BY CNO DESC
	</select>
	
	<select id="selectItemQty" resultType="com.hongsi.quantity.vo.QuantityVO">
	SELECT 
		CNO,
		CODE,
		NAME,
		AMOUNT,
		INGREDIENT,
		IGT_CODE,
		QTY
	FROM 	QUANTITY
	WHERE	NAME = #{NAME} 
	ORDER BY CNO ASC
	
	</select>

	<select id="selectTotalByItem" resultType="com.hongsi.quantity.vo.QuantityVO">
	SELECT 
		QUANTITY.CNO,
		QUANTITY.CODE,
		QUANTITY.NAME,
		QUANTITY.AMOUNT,
		QUANTITY.INGREDIENT,
		QUANTITY.IGT_CODE,
		QUANTITY.QTY,
		AL.ITEM ITEM,
		NVL(AL.TOTAL, 0) TOTAL
	FROM 	QUANTITY,	  
		( SELECT A.ITEM ITEM, (A.INTOTAL - A.OUTTOTAL - A.DISTOTAL) TOTAL
		FROM 
		(	SELECT 	ITEM,
					SUM(CASE WHEN GUBUN = '구매' THEN SUMQTY ELSE 0 END) INTOTAL,
					SUM(CASE WHEN GUBUN = '반품' THEN SUMQTY ELSE 0 END) OUTTOTAL,
					SUM(CASE WHEN GUBUN = '폐기' THEN SUMQTY ELSE 0 END) DISTOTAL
			FROM PURCHASE_BOOK
			GROUP BY ITEM
		) A ) AL 
	WHERE	QUANTITY.CODE = #{code} AND QUANTITY.IGT_CODE = AL.ITEM(+)
	ORDER BY QUANTITY.CNO DESC	
	</select>

	<select id="selectAllIngreStock" resultType="com.hongsi.quantity.vo.QuantityVO">
	SELECT 	II.KNAME KNAME, II.ENAME ENAME, II.CODE CODE, 
			NVL(II.ORI_QTY, 0) ORI_QTY, NVL(II.ORI_QTY_2WEEK, 0) ORI_QTY_2WEEK, 
			NVL(II.ERL_QTY, 0) ERL_QTY, NVL(II.ERL_QTY_2WEEK, 0) ERL_QTY_2WEEK,  
			NVL(II.SNS_QTY, 0) SNS_QTY, NVL(II.SNS_QTY_2WEEK, 0) SNS_QTY_2WEEK, 
			NVL(II.ST.TOTAL, 0) TOTAL, 
			(NVL(II.ORI_QTY_2WEEK, 0) + NVL(II.ERL_QTY_2WEEK, 0) + NVL(II.SNS_QTY_2WEEK, 0)) NEED2WEEK
	FROM (
		SELECT I.KNAME, I.ENAME, I.CODE, I.ORI_QTY, I.ORI_QTY_2WEEK, I.ERL_QTY, I.ERL_QTY_2WEEK, I.SNS_QTY, I.SNS_QTY_2WEEK
		FROM (
			SELECT ORI_ERL.CODE, ORI_ERL.KNAME, ORI_ERL.ENAME, ORI_ERL.ORI_QTY, ORI_ERL.ORI_QTY_2WEEK, ORI_ERL.ERL_QTY, ORI_ERL.ERL_QTY_2WEEK, D.SNS_QTY, D.SNS_QTY_2WEEK
			FROM
			(
				SELECT ORI.CODE CODE, ORI.KNAME KNAME, ORI.ENAME ENAME, ORI.ORI_QTY ORI_QTY, ORI.ORI_QTY_2WEEK ORI_QTY_2WEEK, C.ERL_QTY ERL_QTY , C.ERL_QTY_2WEEK ERL_QTY_2WEEK
				FROM
				(
					SELECT A.CODE, A.KNAME, A.ENAME, B.ORI_QTY, B.ORI_QTY_2WEEK
					FROM
					(	<!-- 재료 목록 구하기 -->
						SELECT  CODE, KNAME, ENAME FROM INGREDIENT 
					) A
					LEFT OUTER JOIN 
					(	<!-- ORIGINAL 100g 재료 구하기, 재고 비축으로 500g 80개 2주분(1주에 40개) 재료 구하기  -->
						SELECT  IGT_CODE, INGREDIENT, QTY ORI_QTY, QTY*5*(40*2) ORI_QTY_2WEEK 
						FROM QUANTITY
						WHERE NAME ='ORI_100'
					) B
					ON A.CODE = B.IGT_CODE					
				) ORI
				LEFT OUTER JOIN 
				(	<!-- EARLGREY 100g 재료 구하기 -->
					SELECT  IGT_CODE, INGREDIENT, QTY ERL_QTY, QTY*5*(40*2) ERL_QTY_2WEEK
					FROM QUANTITY
					WHERE NAME ='ERL_100'
				) C
				ON ORI.CODE = C.IGT_CODE
			) ORI_ERL
			LEFT OUTER JOIN 
			(	<!-- SWEET & SALTY 100g 재료 구하기 -->
				SELECT  IGT_CODE, INGREDIENT, QTY SNS_QTY, QTY*5*(40*2) SNS_QTY_2WEEK 
				FROM QUANTITY
				WHERE NAME ='SNS_100'
			) D
			ON ORI_ERL.CODE = D.IGT_CODE 
		) I 
	) II
	LEFT OUTER JOIN 
	(   <!-- 전 재료의 재고량 STOCK AS S / ST -->
		SELECT S.ITEM ITEM, (S.INTOTAL - S.OUTTOTAL - S.DISTOTAL) TOTAL
		FROM 
		(	SELECT 	ITEM,
					SUM(CASE WHEN GUBUN = '구매' THEN SUMQTY ELSE 0 END) INTOTAL,
					SUM(CASE WHEN GUBUN = '반품' THEN SUMQTY ELSE 0 END) OUTTOTAL,
					SUM(CASE WHEN GUBUN = '폐기' THEN SUMQTY ELSE 0 END) DISTOTAL
			FROM PURCHASE_BOOK		
			GROUP BY ITEM
		) S		
	) ST
	ON II.CODE = ST.ITEM
	ORDER BY II.KNAME
	</select>
	
	<select id="selectTotalNeedFinal" resultType="com.hongsi.quantity.vo.QuantityVO">
	SELECT Z.CODE, Z.KNAME, Z.ORINEED ori_qty_2week, Z.ERLNEED erl_qty_2week, Z.SNSNEED sns_qty_2week, Z.TOTAL, Z.NEEDSUM, Z.NEED2WEEK, Z.FINALTOTAL, 
		CASE WHEN Z.FINALNEED >=0 THEN Z.FINALNEED ELSE 0 END AS FINALNEED
	FROM
	(
		SELECT T.CODE, T.KNAME, T.ORINEED, T.ERLNEED, T.SNSNEED, T.NEEDSUM, T.TOTAL, NVL(B.NEED2WEEK,0) NEED2WEEK, 
		T.FINALTOTAL,  NVL(T.NEEDSUM,0) - (NVL(T.TOTAL,0) - NVL(B.NEED2WEEK,0)) FINALNEED
		FROM
		(
			SELECT IGT_CODE CODE2WEEK, SUM(QTY) QTY2WEEK, SUM(NVL(QTY,0)*5*40*2) NEED2WEEK FROM QUANTITY Q GROUP BY IGT_CODE ORDER BY IGT_CODE
		) B
		RIGHT OUTER JOIN
		(
		SELECT C.CODE CODE, C.KNAME KNAME, C.ORINEED, C.ERLNEED, C.SNSNEED, C.NEEDSUM NEEDSUM, A.TOTAL TOTAL, ( NVL(A.TOTAL,0) - NVL(C.NEEDSUM,0)) FINALTOTAL
		FROM (
			SELECT S.ITEM ITEM, (NVL(S.INTOTAL,0) - NVL(S.OUTTOTAL,0) - NVL(S.DISTOTAL,0)) TOTAL
			FROM 
			(	SELECT 	ITEM,
						SUM(CASE WHEN GUBUN = '구매' THEN SUMQTY ELSE 0 END) INTOTAL,
						SUM(CASE WHEN GUBUN = '반품' THEN SUMQTY ELSE 0 END) OUTTOTAL,
						SUM(CASE WHEN GUBUN = '폐기' THEN SUMQTY ELSE 0 END) DISTOTAL
				FROM PURCHASE_BOOK		
				GROUP BY ITEM
				ORDER BY ITEM
			) S
		) A 
		LEFT OUTER JOIN
		(
			SELECT N.CODE, N.KNAME,
			N.ORINEED, N.ERLNEED, N.SNSNEED, (NVL(N.ORINEED, 0) + NVL(N.ERLNEED, 0) + NVL(N.SNSNEED, 0)) NEEDSUM
			FROM 
			(
				SELECT  ING_ORI_ERL.CODE CODE, ING_ORI_ERL.KNAME KNAME, 
				ING_ORI_ERL.ORI_QTY, ING_ORI_ERL.ORISUM, ING_ORI_ERL.ORINEED ORINEED,
				ING_ORI_ERL.ERL_QTY, ING_ORI_ERL.ERLSUM, ING_ORI_ERL.ERLNEED ERLNEED,
				SNS.SNS_QTY, SNS.SNSSUM, SNS.SNSNEED SNSNEED
				FROM 
				(
					SELECT  ING_ORI.CODE, ING_ORI.KNAME, ING_ORI.ORI_IGT_CODE ORI_IGT_CODE, ING_ORI.ORI_QTY ORI_QTY, ING_ORI.ORISUM ORISUM, ING_ORI.ORINEED ORINEED,
					ERL.ERL_IGT_CODE ERL_IGT_CODE, ERL.ERL_QTY, ERL.ERLSUM, ERL.ERLNEED
					FROM 
					(
						SELECT  ING.CODE, ING.KNAME, ORI.ORI_IGT_CODE, ORI.ORI_QTY, ORI.ORISUM, ORI.ORINEED 
						FROM 
						(
							SELECT  CODE, KNAME, ENAME FROM INGREDIENT
						) ING
						LEFT OUTER JOIN 
						(
							SELECT QTY.IGT_CODE ORI_IGT_CODE, QTY.QTY ORI_QTY, PURCH.ORISUM, (QTY.QTY * (PURCH.ORISUM/100)) ORINEED
							FROM 
							(
								SELECT IGT_CODE, QTY FROM QUANTITY 
								WHERE 1=1
								AND NAME ='ORI_100'
								ORDER BY IGT_CODE
							) QTY
							, 
							( 	
								SELECT 
								(SUM(ORI_200)*200)+(SUM(ORI_500)*500)+(SUM(ORI_1000)*1000) ORISUM
								FROM PURCHSHOP
								WHERE 1=1
								AND TO_DATE(ORDERDATE,'YYYY-MM-DD') 
								BETWEEN TO_DATE(TRUNC(SYSDATE, 'IW')-1,'YYYY-MM-DD') AND TO_DATE(TRUNC(SYSDATE, 'IW')+5,'YYYY-MM-DD')
							) PURCH
						) ORI
						ON ING.CODE = ORI.ORI_IGT_CODE
					) ING_ORI
					LEFT OUTER JOIN 
					(
						SELECT QTY.IGT_CODE ERL_IGT_CODE, QTY.QTY ERL_QTY, PURCH.ERLSUM, (QTY.QTY * PURCH.ERLSUM/100) ERLNEED
						FROM 
						(
							SELECT IGT_CODE , QTY FROM QUANTITY 
							WHERE 1=1
							AND NAME ='ERL_100'
							ORDER BY IGT_CODE
						) QTY, 
						( 
							SELECT 
							(SUM(ERL_200)*200)+(SUM(ERL_500)*500)+(SUM(ERL_1000)*1000) ERLSUM
							FROM PURCHSHOP
							WHERE 1=1
							AND TO_DATE(ORDERDATE,'YYYY-MM-DD') 
							BETWEEN TO_DATE(TRUNC(SYSDATE, 'IW')-1,'YYYY-MM-DD') AND TO_DATE(TRUNC(SYSDATE, 'IW')+5,'YYYY-MM-DD')
						) PURCH
					) ERL
					ON ING_ORI.CODE = ERL.ERL_IGT_CODE	
				) ING_ORI_ERL
				LEFT OUTER JOIN 
				(
					SELECT QTY.IGT_CODE SNS_IGT_CODE, QTY.QTY SNS_QTY, PURCH.SNSSUM, (QTY.QTY * PURCH.SNSSUM/100) SNSNEED
					FROM 
					(
						SELECT IGT_CODE, QTY FROM QUANTITY 
						WHERE 1=1
						AND NAME ='SNS_100'
					) QTY, 
					( 
						SELECT 
						(SUM(SNS_200)*200)+(SUM(SNS_500)*500)+(SUM(SNS_1000)*1000) SNSSUM
						FROM PURCHSHOP
						WHERE 1=1
						AND TO_DATE(ORDERDATE,'YYYY-MM-DD') 
						BETWEEN TO_DATE(TRUNC(SYSDATE, 'IW')-1,'YYYY-MM-DD') AND TO_DATE(TRUNC(SYSDATE, 'IW')+5,'YYYY-MM-DD')
					) PURCH
				) SNS
				ON ING_ORI_ERL.CODE=SNS.SNS_IGT_CODE
			) N	
		) C
		ON C.CODE = A.ITEM
		) T
		ON T.CODE = B.CODE2WEEK
	) Z
	ORDER BY Z.KNAME
	</select>
	
 </mapper>
 

<!--
 ******************************* ORIGINAL, EARLGREY, SWEET & SALTY 100G 함류량 ********************************************
SELECT ori_erl.code, ori_erl.kname, ori_erl.ename, ori_erl.ori_igt_code, ori_erl.ori_qty, ori_erl.erl_igt_code, ori_erl.erl_qty, d.igt_code, d.sns_qty
from
(SELECT ori.code code, ori.kname kname, ori.ename ename, ori.igt_code ori_igt_code, ori.ori_qty ori_qty, c.igt_code erl_igt_code, c.erl_qty erl_qty 
from
(SELECT a.code, a.kname, a.ename, b.igt_code, b.ori_qty
from
(select  code, kname, ename
from INGREDIENT 
) a
left OUTER JOIN 
(select  igt_code, ingredient, qty ori_qty
from quantity
where NAME ='ORI_100') b
ON a.code = b.igt_code
ORDER BY a.code ) ori
left OUTER JOIN 
(select  igt_code, ingredient, qty erl_qty
from quantity
where NAME ='ERL_100') c
ON ori.code = c.igt_code) ori_erl
left OUTER JOIN 
(select  igt_code, ingredient, qty sns_qty
from quantity
where NAME ='SNS_100') d
ON ori_erl.code = d.igt_code

******************************* ORIGINAL, EARLGREY, SWEET & SALTY 100G 함류량 + 전제 재고 *******************************

SELECT II.KNAME KNAME, II.ENAME ENAME, II.CODE CODE, NVL(II.ORI_QTY, 0) ORI_QTY, NVL(II.ERL_QTY, 0) ERL_QTY, NVL(II.SNS_QTY, 0) SNS_QTY, NVL(II.ST.TOTAL, 0) TOTAL
FROM (
	SELECT I.KNAME, I.ENAME, I.CODE, I.ORI_QTY, I.ERL_QTY, I.SNS_QTY
	FROM (
		SELECT ORI_ERL.CODE, ORI_ERL.KNAME, ORI_ERL.ENAME, ORI_ERL.ORI_QTY, ORI_ERL.ERL_QTY, D.SNS_QTY
		FROM
		(
			SELECT ORI.CODE CODE, ORI.KNAME KNAME, ORI.ENAME ENAME, ORI.ORI_QTY ORI_QTY, C.ERL_QTY ERL_QTY 
			FROM
			(
				SELECT A.CODE, A.KNAME, A.ENAME, B.ORI_QTY
				FROM
				(	// 재료 목록 구하기
					SELECT  CODE, KNAME, ENAME FROM INGREDIENT 
				) A
				LEFT OUTER JOIN 
				(	// ORIGINAL 100g 재료 구하기
					SELECT  IGT_CODE, INGREDIENT, QTY ORI_QTY
					FROM QUANTITY
					WHERE NAME ='ORI_100'
				) B
				ON A.CODE = B.IGT_CODE
				ORDER BY A.CODE 
			) ORI
			LEFT OUTER JOIN 
			(	// EARLGREY 100g 재료 구하기
				SELECT  IGT_CODE, INGREDIENT, QTY ERL_QTY
				FROM QUANTITY
				WHERE NAME ='ERL_100'
			) C
			ON ORI.CODE = C.IGT_CODE
		) ORI_ERL
		LEFT OUTER JOIN 
		(	// SWEET & SALTY 100g 재료 구하기
			SELECT  IGT_CODE, INGREDIENT, QTY SNS_QTY
			FROM QUANTITY
			WHERE NAME ='SNS_100'
		) D
		ON ORI_ERL.CODE = D.IGT_CODE 
	) I 
) II
LEFT OUTER JOIN 
(  // 전 재료의 재고량 STOCK AS S / ST
	SELECT S.ITEM ITEM, (S.INTOTAL - S.OUTTOTAL - S.DISTOTAL) TOTAL
	FROM 
	(	SELECT 	ITEM,
				SUM(CASE WHEN GUBUN = '구매' THEN SUMQTY ELSE 0 END) INTOTAL,
				SUM(CASE WHEN GUBUN = '반품' THEN SUMQTY ELSE 0 END) OUTTOTAL,
				SUM(CASE WHEN GUBUN = '폐기' THEN SUMQTY ELSE 0 END) DISTOTAL
		FROM PURCHASE_BOOK		
		GROUP BY ITEM
	) S 
	ORDER BY S.ITEM 
) ST
ON II.CODE = ST.ITEM	
 -->