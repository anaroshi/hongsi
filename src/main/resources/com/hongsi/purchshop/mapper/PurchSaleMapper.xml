<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 1. com.hongsi.purchshop.mapper.PurchSaleMapper 인터페이스 선언 -->
<!-- 2. root-context.xml <mybatis-spring:scan ~~ /> 태그로 기본 패키지 지정 -->
<!-- 3. com.hongsi.purchshop.mapper.PurchSaleMapper.xml 실행 작성 - src/main/resources -->
<!-- <![CDATA[ 이 사이에 있는 것은 mybatis가 처리하지 않고 그대로 넘긴다. DB에서 처리되도록 ]]> -->

<mapper namespace="com.hongsi.purchshop.mapper.PurchSaleMapper">
	
	<!-- 판매 정보 저장 -->
	<insert id="insertSale">
	INSERT INTO PURCH_SALE (
		CNO,
		ORDER_CNO,
		SALEDATE,
		ORI_250,
		ORI_500,
		ORI_1000,
		ERL_250,		
		ERL_500,		
		ERL_1000,	
		SNS_250,		
		SNS_500,
		SNS_1000,
		GUBUN,
		PRICE,
		PAYMENTPATH,
		SALEPATH,
		DELEVERYDATE,
		DELEVERYPATH,
		ORDERER,
		ORDERDATE,
		COMM,
		MANAGER,
		GUBUNCODE,
		STATUS,
		FLAG
	) VALUES (
		PURCHSALE_PK.NEXTVAL,
		#{order_cno},
		#{saleDate},
		#{ori_250},
		#{ori_500},
		#{ori_1000},
		#{erl_250},
		#{erl_500},
		#{erl_1000},
		#{sns_250},
		#{sns_500},
		#{sns_1000},
		#{gubun},
		#{price},
		#{paymentPath},
		#{salePath},
		TO_DATE(#{deleveryDate},'YYYY-MM-DD'),
		#{deleveryPath},
		#{orderer},
		TO_DATE(#{orderDate},'YYYY-MM-DD'),
		#{comm},
		#{manager},
		#{gubunCode},
		'sale',
		1
	)
	</insert>
	
	<!-- Trace : 판매 정보 저장 -->
	<insert id="insertSaleTrace">
	INSERT INTO PURCH_SALE_TRACE (
		UNQ,
		CNO,
		ORDER_CNO,
		SALEDATE,
		ORI_250,
		ORI_500,
		ORI_1000,
		ERL_250,		
		ERL_500,		
		ERL_1000,	
		SNS_250,		
		SNS_500,
		SNS_1000,
		GUBUN,
		PRICE,
		PAYMENTPATH,
		SALEPATH,
		DELEVERYDATE,
		DELEVERYPATH,
		ORDERER,
		ORDERDATE,
		COMM,
		MANAGER,
		GUBUNCODE,
		STATUS,
		FLAG
	) VALUES (
		PURCHSALE_TRACE_PK.NEXTVAL,
		#{cno},
		#{order_cno},
		#{saleDate},
		#{ori_250},
		#{ori_500},
		#{ori_1000},
		#{erl_250},
		#{erl_500},
		#{erl_1000},
		#{sns_250},
		#{sns_500},
		#{sns_1000},
		#{gubun},
		#{price},
		#{paymentPath},
		#{salePath},
		TO_DATE(#{deleveryDate},'YYYY-MM-DD'),
		#{deleveryPath},
		#{orderer},
		TO_DATE(#{orderDate},'YYYY-MM-DD'),
		#{comm},
		#{manager},
		#{gubunCode},
		#{status},
		#{flag}
	)
	</insert>

	<!-- 판매 정보 리스트 -->
	<select id="selectSaleList" resultType="com.hongsi.purchshop.vo.PurchSaleVO">
	SELECT 
		CNO,
		ORDER_CNO,
		SALEDATE,
		ORI_250,
		ORI_500,
		ORI_1000,
		ERL_250,		
		ERL_500,		
		ERL_1000,	
		SNS_250,		
		SNS_500,
		SNS_1000,
		GUBUN,
		PRICE,
		PAYMENTPATH,
		SALEPATH,
		TO_CHAR(DELEVERYDATE, 'yyyy-MM-dd') DELEVERYDATE,
		DELEVERYPATH,
		ORDERER,
		TO_CHAR(ORDERDATE, 'yyyy-MM-dd') ORDERDATE,
		COMM,
		MANAGER,
		GUBUNCODE,
		STATUS
	FROM 	PURCH_SALE
	WHERE 	STATUS = 'sale'
	AND 	FLAG != 4
	ORDER BY SALEDATE DESC	
	</select>
	
	<!-- 일~토요일 날짜 구하기 -->
	<select id="getWeekDay" resultType="com.hongsi.purchshop.vo.PurchSaleVO">
	SELECT 
		TO_CHAR(A.SUNDAY,'YYYY-MM-DD (DY)','NLS_DATE_LANGUAGE=KOREAN') startDate, 
		TO_CHAR(A.SATURDAY,'YYYY-MM-DD (DY)','NLS_DATE_LANGUAGE=KOREAN') endDate, 
		TO_CHAR(A.TODAY,'YYYY-MM-DD (DY)','NLS_DATE_LANGUAGE=KOREAN') toDate 
	FROM 
	(
		SELECT TRUNC(SYSDATE, 'IW')-1 AS SUNDAY, 
			TRUNC(SYSDATE, 'IW')+5 AS SATURDAY,
			TRUNC(SYSDATE) AS TODAY
		FROM DUAL
	) A		
	</select>
	
	<!-- 판매 정보 리스트 -->
	<select id="selectSaleStock" resultType="com.hongsi.purchshop.vo.PurchSaleVO">	
	SELECT 	
		(B.OUT_ORI_250_TOTAL-A.IN_ORI_250_TOTAL) 	ORI_250_SUM,
		(B.OUT_ORI_500_TOTAL-A.IN_ORI_500_TOTAL) 	ORI_500_SUM,
		(B.OUT_ORI_1000_TOTAL-A.IN_ORI_1000_TOTAL) 	ORI_1000_SUM,
		(D.OUT_ERL_250_TOTAL-C.IN_ERL_250_TOTAL) 	ERL_250_SUM,
		(D.OUT_ERL_500_TOTAL-C.IN_ERL_500_TOTAL) 	ERL_500_SUM,
		(D.OUT_ERL_1000_TOTAL-C.IN_ERL_1000_TOTAL) 	ERL_1000_SUM,
		(F.OUT_SNS_250_TOTAL-E.IN_SNS_250_TOTAL) 	SNS_250_SUM,
		(F.OUT_SNS_500_TOTAL-E.IN_SNS_500_TOTAL) 	SNS_500_SUM,
		(F.OUT_SNS_1000_TOTAL-E.IN_SNS_1000_TOTAL) 	SNS_1000_SUM	
	FROM 
	(
		SELECT 	
			NVL(SUM(ORI_250),0) IN_ORI_250_TOTAL,
			NVL(SUM(ORI_500),0) IN_ORI_500_TOTAL,
			NVL(SUM(ORI_1000),0) IN_ORI_1000_TOTAL
		FROM 	PURCH_SALE
		WHERE 	GUBUNCODE = 'in'
		AND 	FLAG != 4
	) A,
	(
		SELECT 	
			NVL(SUM(ORI_250),0) OUT_ORI_250_TOTAL,
			NVL(SUM(ORI_500),0) OUT_ORI_500_TOTAL,
			NVL(SUM(ORI_1000),0) OUT_ORI_1000_TOTAL
		FROM 	PURCH_SALE
		WHERE 	GUBUNCODE = 'out'
		AND 	FLAG != 4
	) B,
	(
		SELECT 	
			NVL(SUM(ERL_250),0) IN_ERL_250_TOTAL,
			NVL(SUM(ERL_500),0) IN_ERL_500_TOTAL,
			NVL(SUM(ERL_1000),0) IN_ERL_1000_TOTAL
		FROM 	PURCH_SALE
		WHERE 	GUBUNCODE = 'in'
		AND 	FLAG != 4
	) C,
	(
		SELECT 	
			NVL(SUM(ERL_250),0) OUT_ERL_250_TOTAL,
			NVL(SUM(ERL_500),0) OUT_ERL_500_TOTAL,
			NVL(SUM(ERL_1000),0) OUT_ERL_1000_TOTAL
		FROM 	PURCH_SALE
		WHERE 	GUBUNCODE = 'out'
		AND 	FLAG != 4
	) D,
	(
		SELECT 	
			NVL(SUM(SNS_250),0) IN_SNS_250_TOTAL,
			NVL(SUM(SNS_500),0) IN_SNS_500_TOTAL,
			NVL(SUM(SNS_1000),0) IN_SNS_1000_TOTAL
		FROM 	PURCH_SALE
		WHERE 	GUBUNCODE = 'in'
		AND 	FLAG != 4
	) E,
	(
		SELECT 	
			NVL(SUM(SNS_250),0) OUT_SNS_250_TOTAL,
			NVL(SUM(SNS_500),0) OUT_SNS_500_TOTAL,
			NVL(SUM(SNS_1000),0) OUT_SNS_1000_TOTAL
		FROM 	PURCH_SALE
		WHERE 	GUBUNCODE = 'out'
		AND 	FLAG != 4
	) F
	</select>
	
	<!-- 판매 정보 리스트 하단의 합계 -->
	<select id="selectStock" resultType="com.hongsi.purchshop.vo.PurchSaleVO">
	SELECT 	
		(PT.PORDUCT_ORI_250_SUM-SL.SALE_ORI_250_SUM) 	ORI_250_SUM,
		(PT.PORDUCT_ORI_500_SUM-SL.SALE_ORI_500_SUM) 	ORI_500_SUM,
		(PT.PORDUCT_ORI_1000_SUM-SL.SALE_ORI_1000_SUM) 	ORI_1000_SUM,
		(PT.PORDUCT_ERL_250_SUM-SL.SALE_ERL_250_SUM) 	ERL_250_SUM,
		(PT.PORDUCT_ERL_500_SUM-SL.SALE_ERL_500_SUM) 	ERL_500_SUM,
		(PT.PORDUCT_ERL_1000_SUM-SL.SALE_ERL_1000_SUM) 	ERL_1000_SUM,
		(PT.PORDUCT_SNS_250_SUM-SL.SALE_SNS_250_SUM) 	SNS_250_SUM,
		(PT.PORDUCT_SNS_500_SUM-SL.SALE_SNS_500_SUM) 	SNS_500_SUM,
		(PT.PORDUCT_SNS_1000_SUM-SL.SALE_SNS_1000_SUM) 	SNS_1000_SUM
	FROM 	
	(
		SELECT 	
			(A.IN_ORI_250_TOTAL-B.OUT_ORI_250_TOTAL) 	PORDUCT_ORI_250_SUM,
			(A.IN_ORI_500_TOTAL-B.OUT_ORI_500_TOTAL) 	PORDUCT_ORI_500_SUM,
			(A.IN_ORI_1000_TOTAL-B.OUT_ORI_1000_TOTAL) 	PORDUCT_ORI_1000_SUM,
			(C.IN_ERL_250_TOTAL-D.OUT_ERL_250_TOTAL) 	PORDUCT_ERL_250_SUM,
			(C.IN_ERL_500_TOTAL-D.OUT_ERL_500_TOTAL) 	PORDUCT_ERL_500_SUM,
			(C.IN_ERL_1000_TOTAL-D.OUT_ERL_1000_TOTAL) 	PORDUCT_ERL_1000_SUM,
			(E.IN_SNS_250_TOTAL-F.OUT_SNS_250_TOTAL) 	PORDUCT_SNS_250_SUM,
			(E.IN_SNS_500_TOTAL-F.OUT_SNS_500_TOTAL) 	PORDUCT_SNS_500_SUM,
			(E.IN_SNS_1000_TOTAL-F.OUT_SNS_1000_TOTAL) 	PORDUCT_SNS_1000_SUM		
		FROM 
		(
			SELECT 	
					NVL(SUM(ORI_250),0) IN_ORI_250_TOTAL,
					NVL(SUM(ORI_500),0) IN_ORI_500_TOTAL,
					NVL(SUM(ORI_1000),0) IN_ORI_1000_TOTAL
			FROM 	PURCH_PRODUCT
			WHERE 	GUBUNCODE = 'in'
			AND 	FLAG != 4
		) A,
		(
			SELECT 	
					NVL(SUM(ORI_250),0) OUT_ORI_250_TOTAL,
					NVL(SUM(ORI_500),0) OUT_ORI_500_TOTAL,
					NVL(SUM(ORI_1000),0) OUT_ORI_1000_TOTAL
			FROM 	PURCH_PRODUCT
			WHERE 	GUBUNCODE = 'out'
			AND 	FLAG != 4
		) B,
		(
			SELECT 	
					NVL(SUM(ERL_250),0) IN_ERL_250_TOTAL,
					NVL(SUM(ERL_500),0) IN_ERL_500_TOTAL,
					NVL(SUM(ERL_1000),0) IN_ERL_1000_TOTAL
			FROM 	PURCH_PRODUCT
			WHERE 	GUBUNCODE = 'in'
			AND 	FLAG != 4
		) C,
		(
			SELECT 	
					NVL(SUM(ERL_250),0) OUT_ERL_250_TOTAL,
					NVL(SUM(ERL_500),0) OUT_ERL_500_TOTAL,
					NVL(SUM(ERL_1000),0) OUT_ERL_1000_TOTAL
			FROM 	PURCH_PRODUCT
			WHERE 	GUBUNCODE = 'out'
			AND 	FLAG != 4
		) D,
		(
			SELECT 	
					NVL(SUM(SNS_250),0) IN_SNS_250_TOTAL,
					NVL(SUM(SNS_500),0) IN_SNS_500_TOTAL,
					NVL(SUM(SNS_1000),0) IN_SNS_1000_TOTAL
			FROM 	PURCH_PRODUCT
			WHERE 	GUBUNCODE = 'in'
			AND 	FLAG != 4
		) E,
		(
			SELECT 	
					NVL(SUM(SNS_250),0) OUT_SNS_250_TOTAL,
					NVL(SUM(SNS_500),0) OUT_SNS_500_TOTAL,
					NVL(SUM(SNS_1000),0) OUT_SNS_1000_TOTAL
			FROM 	PURCH_PRODUCT
			WHERE 	GUBUNCODE = 'out'
			AND 	FLAG != 4
		) F
	) PT,
	(
		SELECT 	
			(B.OUT_ORI_250_TOTAL-A.IN_ORI_250_TOTAL) 	SALE_ORI_250_SUM,
			(B.OUT_ORI_500_TOTAL-A.IN_ORI_500_TOTAL) 	SALE_ORI_500_SUM,
			(B.OUT_ORI_1000_TOTAL-A.IN_ORI_1000_TOTAL) 	SALE_ORI_1000_SUM,
			(D.OUT_ERL_250_TOTAL-C.IN_ERL_250_TOTAL) 	SALE_ERL_250_SUM,
			(D.OUT_ERL_500_TOTAL-C.IN_ERL_500_TOTAL) 	SALE_ERL_500_SUM,
			(D.OUT_ERL_1000_TOTAL-C.IN_ERL_1000_TOTAL) 	SALE_ERL_1000_SUM,
			(F.OUT_SNS_250_TOTAL-E.IN_SNS_250_TOTAL) 	SALE_SNS_250_SUM,
			(F.OUT_SNS_500_TOTAL-E.IN_SNS_500_TOTAL) 	SALE_SNS_500_SUM,
			(F.OUT_SNS_1000_TOTAL-E.IN_SNS_1000_TOTAL) 	SALE_SNS_1000_SUM		
		FROM 
		
		(
			SELECT 	
					NVL(SUM(ORI_250),0) IN_ORI_250_TOTAL,
					NVL(SUM(ORI_500),0) IN_ORI_500_TOTAL,
					NVL(SUM(ORI_1000),0) IN_ORI_1000_TOTAL
			FROM 	PURCH_SALE
			WHERE 	GUBUNCODE = 'in'
			AND 	FLAG != 4
		) A,
		(
			SELECT 	
					NVL(SUM(ORI_250),0) OUT_ORI_250_TOTAL,
					NVL(SUM(ORI_500),0) OUT_ORI_500_TOTAL,
					NVL(SUM(ORI_1000),0) OUT_ORI_1000_TOTAL
			FROM 	PURCH_SALE
			WHERE 	GUBUNCODE = 'out'
			AND 	FLAG != 4
		) B,
		(
			SELECT 	
					NVL(SUM(ERL_250),0) IN_ERL_250_TOTAL,
					NVL(SUM(ERL_500),0) IN_ERL_500_TOTAL,
					NVL(SUM(ERL_1000),0) IN_ERL_1000_TOTAL
			FROM 	PURCH_SALE
			WHERE 	GUBUNCODE = 'in'
			AND 	FLAG != 4
		) C,
		(
			SELECT 	
					NVL(SUM(ERL_250),0) OUT_ERL_250_TOTAL,
					NVL(SUM(ERL_500),0) OUT_ERL_500_TOTAL,
					NVL(SUM(ERL_1000),0) OUT_ERL_1000_TOTAL
			FROM 	PURCH_SALE
			WHERE 	GUBUNCODE = 'out'
			AND 	FLAG != 4
		) D,
		(
			SELECT 	
					NVL(SUM(SNS_250),0) IN_SNS_250_TOTAL,
					NVL(SUM(SNS_500),0) IN_SNS_500_TOTAL,
					NVL(SUM(SNS_1000),0) IN_SNS_1000_TOTAL
			FROM 	PURCH_SALE
			WHERE 	GUBUNCODE = 'in'
			AND 	FLAG != 4
		) E,
		(
			SELECT 	
					NVL(SUM(SNS_250),0) OUT_SNS_250_TOTAL,
					NVL(SUM(SNS_500),0) OUT_SNS_500_TOTAL,
					NVL(SUM(SNS_1000),0) OUT_SNS_1000_TOTAL
			FROM 	PURCH_SALE
			WHERE 	GUBUNCODE = 'out'
			AND 	FLAG != 4
		) F
	) SL	
	</select>
	
	<!--판매 정보 구하기 By Cno -->
	<select id="selectSaleInfoByCno" resultType="com.hongsi.purchshop.vo.PurchSaleVO">
	SELECT
		CNO,		
		SALEDATE,
		ORI_250,
		ORI_500,
		ORI_1000,
		ERL_250,		
		ERL_500,		
		ERL_1000,	
		SNS_250,		
		SNS_500,
		SNS_1000,
		GUBUN,
		PRICE,
		PAYMENTPATH,
		SALEPATH,
		TO_CHAR(DELEVERYDATE, 'yyyy-MM-dd') DELEVERYDATE,
		DELEVERYPATH,
		ORDERER,
		TO_CHAR(ORDERDATE, 'yyyy-MM-dd') ORDERDATE,
		COMM,
		MANAGER
	FROM 	PURCH_SALE
	WHERE 	CNO = #{cno}
	AND		FLAG != 4
	</select>	
	
	<!-- 판매 정보 삭제 -->
	<update id="deleteSaleInfoByCno">
	UPDATE 	PURCH_SALE
	SET 	FLAG = 4, UDATE = SYSDATE
	WHERE 	CNO  = #{cno}	
	</update>
	
	<!-- Trace : 판매 정보 삭제 정보 저장 -->
	<insert id="deleteSaleInfoByCnoTrace">
	INSERT INTO PURCH_SALE_TRACE (
		UNQ,
		CNO,
		STATUS,
		FLAG
	) VALUES (
		PURCHSALE_TRACE_PK.NEXTVAL,
		#{cno},
		'sale',
		4
	)
	</insert>

	<!-- 판매 정보 수정 -->
	<update id="updateSaleInfoByCno">
	UPDATE 	PURCH_SALE
	SET 	SALEDATE = #{saleDate},
			ORI_250 = #{ori_250},
			ORI_500 = #{ori_500},
			ORI_1000 = #{ori_1000},
			ERL_250 = #{erl_250},		
			ERL_500 = #{erl_500},		
			ERL_1000 = #{erl_1000},	
			SNS_250 = #{sns_250},		
			SNS_500 = #{sns_500},
			SNS_1000 = #{sns_1000},
			GUBUN = #{gubun},
			PRICE = #{price},
			PAYMENTPATH = #{paymentPath},
			SALEPATH = #{salePath},
			DELEVERYDATE = TO_DATE(#{deleveryDate},'YYYYMMDD'),
			DELEVERYPATH = #{deleveryPath},
			COMM = #{comm},
			ORDERDATE = TO_DATE(#{orderDate},'YYYYMMDD'),
			ORDERER = #{orderer},
			MANAGER = #{manager},
			GUBUNCODE = #{gubunCode},
			FLAG = 2, 
			UDATE = SYSDATE
	WHERE 	CNO  = #{cno}	
	</update>
	
</mapper>
